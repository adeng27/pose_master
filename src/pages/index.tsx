import Head from "next/head";
import { useEffect, useRef, useState } from "react";
import { Poses } from "~/components/poses";

export default function Home() {
  const videoRef = useRef<HTMLVideoElement>(null);
  const photoRef = useRef<HTMLCanvasElement>(null);

  const [imageUrl, setImageUrl] = useState("");

  useEffect(() => {
    getVideo();
  }, [videoRef]);

  const getVideo = () => {
    navigator.mediaDevices
      .getUserMedia({ video: { width: 378, height: 504} })
      .then(async stream => {
        const video = videoRef.current!;
        video.srcObject = stream;
        await video.play();
      })
      .catch(err => {
        console.error("error:", err);
      });
  };

  const paintToCanvas = () => {
    const video = videoRef.current!;
    const photo = photoRef.current!;
    const ctx = photo.getContext('2d')!;

    const width = 378;
    const height = 504;
    photo.width = width;
    photo.height = height;

    ctx.drawImage(video, 0, 0, width, height);
    return true;
  };

  const takePhoto = () => {
    const photo = photoRef.current!;

    const data = photo.toDataURL('image/jpeg');
    setImageUrl(data);

    // console.warn(data);
  };

  const [countdown, setCountdown] = useState(3);

  return (
    <>
      <Head>
        <title>Pose Master</title>
        <meta name="description" content="Generated by create-t3-app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className="flex min-h-screen flex-col items-center justify-center bg-gradient-to-b from-[#2e026d] to-[#15162c]">
        <div className="container flex flex-col items-center justify-center gap-12 px-4 py-16 ">
          {imageUrl !== "" && <Poses imageUrl={imageUrl} />}
          <div className="flex flex-col gap-8">
            <button onClick={() => {
              setTimeout(() => setCountdown(2), 1000)
              setTimeout(() => setCountdown(1), 2000)
              setTimeout(() => {
                setCountdown(0)
                if (paintToCanvas()) {
                  takePhoto();
                }
              }, 5000)
            }}>Take a photo</button>
            <video ref={videoRef} />
            <div className="flex justify-center text-white">
              { countdown }
            </div>
            <canvas ref={photoRef} className="hidden" />
          </div>
        </div>
      </main>
    </>
  );
}
